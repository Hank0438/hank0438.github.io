---
layout: post
title: "Windows Kernel Exploit Part 1 - Debug Settings"
categories: pwn
---

## Enable DbgPrint/KdPrint
```
kd> ed nt!Kd_IHVDRIVER_Mask 0xffffffff
kd> ed nt!Kd_DEFAULT_MASK  0xFFFFFFFF

<!-- Or, run the following in console to make it permanent -->
reg add "HKLM\SYSTEM\ControlSet001\Control\Session Manager\Debug Print Filter" /v DEFAULT /t REG_DWORD /d 0xFFFFFFFF
```

## WinDbg cheatsheet
* current process of token privileges 
    ```
    dx ((nt!_TOKEN*)(@$curprocess.KernelObject.Token.Object & ~0xf))->Privileges
    ```
* common
`g` == continue
`dq` == `x/40gx`
`u` == `x/10i`
`u . l50` == show 50 asm at rip 
`bp` == `b`
`bl` == `breakpoints`
`bd 1` == disable breakpoint idx:1
`lm` == list modules
`r` == show registers
`.reload /u driver.sys` == unload driver
`kb` == backtrace

* DBG_print
    * temporarily during runtime from WinDbg (lost once session is closed)
    `kd> ed nt!Kd_Default_Mask 0xf`
    * permanently from registry hive (in Admin prompt on Debuggee)
    `C:\> reg add "HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Debug Print Filter" /v DEFAULT /t REG_DWORD /d 0xf`

* Reference
    * https://www.easefilter.com/Forums_Files/WinDbg_Commands.htm
    * https://github.com/repnz/windbg-cheat-sheet
    * https://github.com/hugsy/defcon_27_windbg_workshop/blob/master/windbg_cheatsheet.md#registers--memory-access

## Environment Setup - Network
    * The host and guset both are Windows 10 VM.
    * The network interface is Virtual Box Host-Only Ethernet Adapter
    * Debuggee: 192.168.56.101
    * Debugger: 192.168.56.102
    * Nice picture from www.nakivo.com
    ![](https://www.nakivo.com/blog/wp-content/uploads/2019/07/VirtualBox-network-settings-%E2%80%93-VMs-use-the-host-only-network.png)

### Debuggee (192.168.56.101)
In order to install unsigned driver, set Windows OS to test-mode 
```
PS> bcdedit /set testsigning on
PS> bcdedit /debug on
```
Setup debugger information and retrieve the key
```
PS> bcdedit /dbgsettings NET HOSTIP:192.168.56.102 PORT:50000
```
Setup debug through which network interface
Copy `VerifiedNICList.xml` and  `kdnet.exe` from host `C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\` to guest 
```
PS> kdnet.exe
PS> bcdedit /set "{dbgsettings}" busparams b.d.f # choose the Virtual Box Host-Only Adapter
```
Show up the debug setting
```
PS> bcdedit /dbgsettings
```
![](https://i.imgur.com/c0LPQNn.png)

### Debugger (192.168.56.102)

* WinDBG Preview is available on Microsoft Store 
WinDBG Preview -> File -> Attach To Kernel -> Net
![](https://i.imgur.com/sfsPmP9.png)

* Configure kernel symbols
Settings -> Debugging settings
```
srv*c:\symbols*https://msdl.microsoft.com/download/symbols
```
![](https://i.imgur.com/knOb3WI.png)


### Debug Reference
https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically
https://medium.com/@ophirharpaz/kdnet-tutorial-for-noobs-68669778bbd4

## Environment Setup - Serial Port


### Debugee

#### COM Port settings
To debug a VMWARE virtual machine, once you have added the COM port to the VM, then in the VM settings:
![](https://i.imgur.com/OIQ0k7s.png)

Note:
  1. The name of the named pipe is \\.\pipe\com2 (you can use whatever you want after \\.\pipe\)
  The COM port number is 2 (see in the picture where it is mentioned "Serial Port 2" on the left pane)
  The two dropboxes with this end is the server and the other end is an application.
  
  2. According to the documentation, about "Yield CPU on Poll":
  This configuration option forces the affected virtual machine to yield processor time if the only task it is trying to do is poll the virtual serial port.

Don't forget to configure the Windows VM with bcdedit:

```
bcdedit /debug on
bcdedit /dbgsettings serial debugport:2 baudrate:115200
```
Restart your VM once this is done. In this case I use the serial port 2 (usually, the first COM port in VMWARE is used by the printer).

### Debugger
* Windbg (command line)
```windbg -k com:pipe,port=\\.\pipe\com2,resets=0,reconnect```

* Windbg (preview)
  * ![](https://i.imgur.com/JEcEsS4.png)

Note:
  1. The host (windng.exe) must gain the admin privilege to have capability to talk with serial port. 

* reference
    * https://stackoverflow.com/questions/33820520/kernel-debug-with-a-vmware-machine
